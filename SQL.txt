CREATE SCHEMA IF NOT EXISTS cinema;
SET search_path TO cinema;

CREATE TABLE user_roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(20) NOT NULL UNIQUE
);

CREATE TABLE persons (
    id SERIAL PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    middle_name VARCHAR(50),
    birth_date DATE NOT NULL,
    photo BYTEA NOT NULL,
    experience_years INTEGER NOT NULL DEFAULT 0
);

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    login VARCHAR(50) NOT NULL UNIQUE,
    pass VARCHAR(255) NOT NULL,
    role_id INTEGER NOT NULL REFERENCES user_roles(id),
    person_id INTEGER NOT NULL UNIQUE REFERENCES persons(id)
);

CREATE TABLE genres (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE movies (
    id SERIAL PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    genre_id INTEGER NOT NULL REFERENCES genres(id),
    budget NUMERIC(15,2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pre-production',
    start_date DATE,
    end_date DATE
);

CREATE TABLE crews (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);

CREATE TABLE movie_crews (
    id SERIAL PRIMARY KEY,
    movie_id INTEGER NOT NULL REFERENCES movies(id),
    crew_id INTEGER NOT NULL REFERENCES crews(id),
    allocated_budget NUMERIC(15,2) NOT NULL,
    UNIQUE (movie_id, crew_id)
);

CREATE TABLE crew_roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE crew_members (
    id SERIAL PRIMARY KEY,
    crew_id INTEGER NOT NULL REFERENCES crews(id),
    person_id INTEGER NOT NULL REFERENCES persons(id),
    role_id INTEGER NOT NULL REFERENCES crew_roles(id),
    UNIQUE (crew_id, person_id, role_id)
);

CREATE TABLE movie_actors (
    id SERIAL PRIMARY KEY,
    movie_id INTEGER NOT NULL REFERENCES movies(id),
    person_id INTEGER NOT NULL REFERENCES persons(id),
    character_name VARCHAR(100) NOT NULL,
    UNIQUE (movie_id, person_id, character_name)
);

CREATE INDEX idx_persons_name ON persons(last_name, first_name);
CREATE INDEX idx_movies_status ON movies(status);
CREATE INDEX idx_movies_budget ON movies(budget);
CREATE INDEX idx_movie_crews_budget ON movie_crews(allocated_budget);
CREATE INDEX idx_crews_name ON crews(name);
CREATE INDEX idx_movie_actors_character ON movie_actors(character_name);
CREATE INDEX idx_users_login ON users(login);
CREATE INDEX idx_genres_name ON genres(name);